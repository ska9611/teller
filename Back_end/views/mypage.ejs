<%- include('header.ejs') %>

<div id="mypageInfo">
    <% if (user && user !== null) { %> <!-- user 객체가 존재하고 null이 아닌 경우에만 실행 -->
        <p><strong>아이디:</strong> <%= user.ID %></p>
        <p><strong>이름:</strong> <%= user.name %></p>
        <p><strong>이메일:</strong> <%= user.email %></p>
        <p><strong>닉네임:</strong> <%= user.nickname %></p>
        <p><strong>전화번호:</strong> <%= user.phone %></p>
        <p><strong>주소:</strong> <%= user.address %></p>
        <button id="editButton">편집</button>
    <% } else { %>
        <p>로그인 후 마이페이지을 확인하세요.</p>
    <% } %>
</div>

<form id="mypageUpdateForm" style="display: none;">
    <% if (user && user !== null) { %> <!-- user 객체가 존재하고 null이 아닌 경우에만 실행 -->
        <label for="ID">아이디:</label>
        <input type="text" id="ID" name="ID" value="<%= user.ID %>"><br><br>

        <label for="email">이메일:</label>
        <input type="email" id="email" name="email" value="<%= user.email %>"><br><br>
        
        <label for="nickname">닉네임:</label>
        <input type="text" id="nickname" name="nickname" value="<%= user.nickname %>"><br><br>
        
        <label for="phone">전화번호:</label>
        <input type="tel" id="phone" name="phone" value="<%= user.phone %>"><br><br>

        <label for="phone">주소:</label>
        <input type="address" id="address" name="address" value="<%= user.address %>"><br><br>
        
        <button type="submit">저장</button>
        <button type="button" id="cancelButton">취소</button>
    <% } %>
</form>

<script>
    const editButton = document.getElementById('editButton');
    const mypageInfo = document.getElementById('mypageInfo');
    const mypageUpdateForm = document.getElementById('mypageUpdateForm');
    const cancelButton = document.getElementById('cancelButton');

    editButton.addEventListener('click', () => {
        mypageInfo.style.display = 'none';
        mypageUpdateForm.style.display = 'block';
    });

    cancelButton.addEventListener('click', () => {
        mypageUpdateForm.style.display = 'none';
        mypageInfo.style.display = 'block';
    });

    mypageUpdateForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const formData = new FormData(event.target);
        const email = formData.get('email');
        const nickname = formData.get('nickname');
        const phone = formData.get('phone');
        const address = formData.get('address');

        try {
            const response = await fetch('/mypage_update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, nickname, phone, address })
            });

            const data = await response.json();
            alert(data.message); // 서버에서 반환한 메시지를 알림으로 보여줍니다.
            
            // 마이페이지 업데이트 성공 시, 화면을 다시 로드하여 변경된 정보를 표시합니다.
            window.location.reload();
        } catch (error) {
            console.error('Error updating mypage:', error);
            alert('마이페이지 업데이트 중 오류가 발생했습니다.');
        }
    });
</script>

<%- include('footer.ejs') %>

